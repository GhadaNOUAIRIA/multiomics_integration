---
title: "Downstream analysis of PSC patients"
author: "William Wu"
date: "2024-08-07"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
    code_folding: "hide"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Background

In this downstrem analysis we will investigate the difference and the biological significance of our selected features with network analysis (WGCNA) and DIABLO (mixOmics).  
We investigate the amount of variables in each model distributed over the different omics and the overlap.  
For the enrichment analysis the plan is to annotate the compound pathway associations with the tools miEAA (miRNA), KEGG (proteins), and compound metadata from Metabolon (metabolites). Currently only the metabolites are analysed.  

## Read the libraries

```{r read_the_libraries}
library(tidyverse)
library(caret)
# library(clusterProfiler)
# library(rWikiPathways)
# library(DOSE)
# library(enrichplot)
library(DT)
```

## Load the data

The omics data comes in a uniform format with each row representing a patient/sample and each column representing a compound/feature/variable except the first column which contains the patient ID's.
The metadata has been cleaned for the variables of interest so that they are represented by new binary columns. See the preprocessing script for details.
```{r load_data}
setwd("~/R/FoLäk2")
#setwd("~/projects/PSC_multiomics")

# Read compound data
metabolites <- read_csv("results/metabolite_preprocessed.csv")
proteins <- read_csv("results/protein_preprocessed.csv")
miRNA <- read_csv("results/miRNA_preprocessed.csv")

# Read metadata
metadata <- read_csv("results/metadata_preprocessed.csv")

# Read compound metadata
metabolites_metadata <- read_csv("data/metadata_metabolomics.csv")
proteins_metadata <- readxl::read_excel("data/Olink_proteins_metadata.xlsx")
```

These are the results from the WGCNA analysis containing all compounds (miRNA, protein, metabolites) their module membership and gene significance.
```{r load_results}
setwd("~/R/FoLäk2")
WGCNA_manual_alp_binary <- read_csv("results/WGCNA/WGCNA_manual_alp_binary.csv")
mixOmics_alp_binary <- read_csv("results/mixOmics/mixOmics_alp_binary.csv")
```

## Prepare the data

The patient ID column is set as the rownames to keep track of the rows.
The metabolite data was probably not log2 transformed but only scaled with 1 as the median and all other values proportional.
-> The metabolite data needs to be log2 transformed
The numerical columns of interest are selected in the metadata
```{r format_data}
miRNA <- miRNA %>% 
  column_to_rownames(var = "patient_id") %>% 
  slice(1:33)
miRNA <- miRNA[,-nearZeroVar(miRNA, uniqueCut = 30)] # cuts 978 miRNA (only mature); cuts 1920 miRNA (mature and hairpin) 

proteins <- proteins %>% 
  column_to_rownames(var = "patient_id") %>% 
  slice(1:33)

metabolites <- metabolites %>% 
  column_to_rownames(var = "patient_id") %>% 
  log2() %>% 
  slice(1:33)
metabolites <- metabolites[,-nearZeroVar(metabolites, uniqueCut = 30)] # cuts 29 metabolites

metadata <- metadata %>% 
  column_to_rownames(var = "patient_id") %>% 
  slice(1:33)
```

We save the compound names of each omics to be used as reference lists when separating our results into different compounds.
```{r save_compound_names}
# miRNA
miRNA_names <- names(miRNA)

# We extract separate lists of mature and hairpin miRNA
setwd("~/R/FoLäk2")
mature <- read_csv('data/miRNA_mature_log.csv')$...1
hairpin <- read_csv('data/miRNA_hairpin_log.csv')$rn

# write_csv(mature, "data/mature.csv")
# write_csv(hairpin, "data/hairpin.csv")

# Proteins
proteins_names <- names(proteins)

# Metabolites
metabolites_names <- names(metabolites)
```

# Model comparison

```{r alp_binary_all}
# Filtering the variables within interesting modules as seen in the WGCNA_multi_omics.Rmd. The gene signficance is set to a minimum absolute value of 0.5.
WGCNA_alp_binary_all <- WGCNA_manual_alp_binary %>% 
  filter(moduleColor %in% c("brown", "green"), 
         GS.alp_binary >= 0.5 | GS.alp_binary <= -0.5)

# No change
mixOmics_alp_binary_all <- mixOmics_alp_binary

# Calculate the intersect
intersect <- inner_join(WGCNA_alp_binary_all, mixOmics_alp_binary_all, by = "compounds")

# Print the results
print(str_c("The WGCNA model had ", nrow(WGCNA_alp_binary_all), " varaibles and the DIABLO model had ", nrow(mixOmics_alp_binary_all), " variables. They shared ", nrow(intersect), " variables."))
```

```{r alp_binary_miRNA}
# Filtering the variables within interesting modules as seen in the WGCNA_multi_omics.Rmd. The gene signficance is set to a minimum absolute value of 0.5.
WGCNA_alp_binary_miRNA <- WGCNA_manual_alp_binary %>% 
  filter(moduleColor %in% c("brown", "green"), 
         GS.alp_binary >= 0.5 | GS.alp_binary <= -0.5) %>% 
  filter(compounds %in% miRNA_names)

# No change
mixOmics_alp_binary_miRNA <- mixOmics_alp_binary %>% 
  filter(compounds %in% miRNA_names)

# Calculate the intersect
intersect <- inner_join(WGCNA_alp_binary_miRNA, mixOmics_alp_binary_miRNA, by = "compounds")

# Print the results
print(str_c("The WGCNA model had ", nrow(WGCNA_alp_binary_miRNA), " varaibles and the DIABLO model had ", nrow(mixOmics_alp_binary_miRNA), " variables. They shared ", nrow(intersect), " variables."))
```

```{r alp_binary_proteins}
# Filtering the variables within interesting modules as seen in the WGCNA_multi_omics.Rmd. The gene signficance is set to a minimum absolute value of 0.5.
WGCNA_alp_binary_proteins <- WGCNA_manual_alp_binary %>% 
  filter(moduleColor %in% c("brown", "green"), 
         GS.alp_binary >= 0.5 | GS.alp_binary <= -0.5) %>% 
  filter(compounds %in% proteins_names)

# No change
mixOmics_alp_binary_proteins <- mixOmics_alp_binary %>% 
  filter(compounds %in% proteins_names)

# Calculate the intersect
intersect <- inner_join(WGCNA_alp_binary_proteins, mixOmics_alp_binary_proteins, by = "compounds")

# Print the results
print(str_c("The WGCNA model had ", nrow(WGCNA_alp_binary_proteins), " varaibles and the DIABLO model had ", nrow(mixOmics_alp_binary_proteins), " variables. They shared ", nrow(intersect), " variables."))
```

```{r alp_binary_metabolites}
# Filtering the variables within interesting modules as seen in the WGCNA_multi_omics.Rmd. The gene signficance is set to a minimum absolute value of 0.5.
WGCNA_alp_binary_metabolites <- WGCNA_manual_alp_binary %>% 
  filter(moduleColor %in% c("brown", "green"), 
         GS.alp_binary >= 0.5 | GS.alp_binary <= -0.5) %>% 
  filter(compounds %in% metabolites_names)

# No change
mixOmics_alp_binary_metabolites <- mixOmics_alp_binary %>% 
  filter(compounds %in% metabolites_names)

# Calculate the intersect
intersect <- inner_join(WGCNA_alp_binary_metabolites, mixOmics_alp_binary_metabolites, by = "compounds")

# Print the results
print(str_c("The WGCNA model had ", nrow(WGCNA_alp_binary_metabolites), " varaibles and the DIABLO model had ", nrow(mixOmics_alp_binary_metabolites), " variables. They shared ", nrow(intersect), " variables."))
```

# miRNA
Link: https://ccb-compute2.cs.uni-saarland.de/mieaa/

**Precursor = Hairpin**  
MirGeneDB  
MNDR  
HMDD  

**Mature**  
MNDR 

miRTarBase https://mirtarbase.cuhk.edu.cn/~miRTarBase/miRTarBase_2022/php/index.php  
gene ontology  
target genes  

miRWalk  
pathways  
organs  
gene ontology  

PublishedDiseases  

## miEAA

Analysis of miRNA for bilirubin with external tool miEAA that uses several other databases. 
```{r miRNA_bilirubin}
# # function(results, miRNAtype, moduleColor == NULL, GS = NULL)
# 
# # for turquoise module
# bilirubin_miRNA <- WGCNA_manual_bilirubin_binary %>% 
#   filter(compounds %in% mature, 
#          moduleColor == "turquoise", 
#          abs(GS.bilirubin_binary) > 0.25)
# 
# # write_csv(bilirubin_miRNA %>% select(1), "~/Downloads/miRNA.csv")
```

# Protein
Additional: GO, disease association db

Analysis of proteins for bilirubin. We conver the list of interesting proteins from OlinkID to Uniprot_ID with the protein metadata.
```{r proteins_bilirubin}
# # for turquoise module
# bilirubin_proteins <- WGCNA_manual_bilirubin_binary %>% 
#   filter(compounds %in% proteins_names, 
#          moduleColor == "brown")
# 
# sig.ptn <- metadata_proteins %>% 
#   filter(OlinkID %in% bilirubin_proteins$compounds)
```

### KEGG

We analyse the proteins with Uniprot_ID through the KEGG databse.
```{r KEGG}
# ## ----kegg_enrichment, message=FALSE, warning=FALSE-----------------------------------------------------------------------------------------------------
# ###Pathway enrichment using KEGG database
# ans.kegg <- enrichKEGG(gene = sig.ptn$Uniprot_ID,
#                        organism = 'hsa',
#                        keyType = "uniprot",
#                        pvalueCutoff = 1)
# datatable(as.data.frame(ans.kegg))
# 
# 
# ## ----kegg_plots, message=FALSE, warning=FALSE----------------------------------------------------------------------------------------------------------
# ###Plotting
# barplot(ans.kegg, showCategory=15)
# dotplot(ans.kegg, showCategory=15) + ggtitle("KEGG")
# upsetplot(ans.kegg)
# ans.kegg1 <- pairwise_termsim(ans.kegg)
# emapplot(ans.kegg1)
# ego <- ans.kegg %>% 
#        mutate(richFactor = Count / as.numeric(sub("/\\d+", "", BgRatio)))
# 
# ggplot(ego, showCategory = 15, 
#        aes(richFactor, fct_reorder(Description, Count))) +
#        geom_segment(aes(xend=0, yend = Description)) +
#        geom_point(aes(color=p.adjust, size = Count)) +
#        scale_color_gradientn (colours=c("#f7ca64", "#46bac2", "#7e62a3"), trans = "log10",
#                               guide=guide_colorbar(reverse=TRUE, order=1)) +
#        scale_size_continuous(range=c(2, 10)) +
#        theme_dose(12) +
#        xlab("Rich Factor") +
#        ylab(NULL) +
#        ggtitle("KEGG based pathway analysis")
# 
# ggplot(ego, showCategory = 15,   
#        aes(Count, fct_reorder(Description, Count), fill=p.adjust)) +
#        geom_col() +
#        scale_fill_gradientn(colours=c("#f7ca64", "#b3eebe", "#7e62a3", "#371ea3"),
#                             guide=guide_colorbar(reverse=TRUE)) +
#        theme_dose(12) +
#        xlab("Protein count") +
#        ylab(NULL) +
#        ggtitle("Pathway analysis based on KEGG")
```

### Wikipathways

We have to convert the Uniprot ID's to Entrez Gene ID's to analyse with wikipathways.
```{r wikipathways}
# setwd("~/R/FoLäk2")
# wikipathways <- readPathwayGMT("data/wikipathways-20240710-gmt-Homo_sapiens.gmt")
# ## ----sig_genes, message=FALSE, warning=FALSE-----------------------------------------------------------------------------------------------------------
# ###preparing protein list for wikipathway (get gene IDs)
# sig.ptn.list <- sig_ptn %>%
#               dplyr::select(EntrezGeneID)
# sig.ptn <- sig.ptn.list[[1]]
# ptn.Universe <- metadata_prot %>%
#                select(EntrezGeneID)
# ptn.Universe <- ptn.Universe[[1]]
# ptn.Universe <- unlist(mget(ptn.Universe, envir=org.Hs.egSYMBOL2EG, ifnotfound = NA))
# 
# 
# ## ----wikipathways, message=FALSE, warning=FALSE--------------------------------------------------------------------------------------------------------
# ###Importing Wikipathways data
# disease2gene <- wikipathways[, c("wpid", "gene")]
# disease2name <- wikipathways[, c("wpid", "name")]
# ###Computing enrichment 
# ans.wkp <- enricher(sig.ptn, TERM2GENE=disease2gene, TERM2NAME=disease2name, pvalueCutoff = 1, universe = ptn.Universe)
# datatable(as.data.frame(ans.wkp))
# 
# 
# ## ----wkp_plots-----------------------------------------------------------------------------------------------------------------------------------------
# ###plotting results
# barplot(ans.wkp, showCategory=15)
# dotplot(ans.wkp, showCategory=15) + ggtitle("Disease db")
# upsetplot(ans.wkp)
# ans.wkp1 <- pairwise_termsim(ans.wkp)
# emapplot(ans.wkp1)
# 
# 
# ## ----signaling, message=FALSE, warning=FALSE-----------------------------------------------------------------------------------------------------------
# ###More plotting
# ego <- ans.wkp %>% 
#        # filter(str_detect(Description, "Calcium")) %>%
#        # filter(p.adjust < 0.001, Count > 10) %>%
#        mutate(richFactor = Count / as.numeric(sub("/\\d+", "", BgRatio)))
# 
# ggplot(ego, showCategory = 15, 
#        aes(richFactor, fct_reorder(Description, Count))) +
#        geom_segment(aes(xend=0, yend = Description)) +
#        geom_point(aes(color=p.adjust, size = Count)) +
#        scale_color_gradientn (colours=c("#f7ca64", "#46bac2", "#7e62a3"), trans = "log10",
#                               guide=guide_colorbar(reverse=TRUE, order=1)) +
#        scale_size_continuous(range=c(2, 10)) +
#        theme_dose(12) +
#        xlab("Rich Factor") +
#        ylab(NULL) +
#        ggtitle("Wikipathways based enrichment analysis")
# 
# ggplot(ego, showCategory = 15, 
#        aes(Count, fct_reorder(Description, Count), fill=qvalue)) +
#        geom_col() +
#        scale_fill_gradientn(colours=c("#b3eebe", "#46bac2", "#371ea3"),
#                             guide=guide_colorbar(reverse=TRUE)) +
#        theme_dose(12) +
#        xlab("Normalized Enrichment Score") +
#        ylab(NULL) +
#        ggtitle("Wikipathway based analysis")

```

# Metabolites
Additional: Reactome

## Metadata

Analysis of metabolites for bilirubin with metadata containg the metabolic pathways.
```{r metabolites_ALP}
# WGCNA
metabolites_metadata %>% 
  filter(`COMP ID` %in% WGCNA_alp_binary_metabolites$compounds) %>% 
  group_by(`SUB PATHWAY`) %>%
  summarise(metabolites = n()) %>%
  arrange(desc(metabolites)) %>% 
  datatable()

# mixOmics
metabolites_metadata %>% 
  filter(`COMP ID` %in% mixOmics_alp_binary_metabolites$compounds) %>% 
  group_by(`SUB PATHWAY`) %>%
  summarise(metabolites = n()) %>%
  arrange(desc(metabolites)) %>% 
  datatable()
```
