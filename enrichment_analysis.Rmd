---
title: "WGCNA analysis of PSC patients"
author: "William Wu"
date: "2024-08-07"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
    code_folding: "hide"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Read the libraries

```{r read_the_libraries}
library(tidyverse)
library(DT)
library(caret)
library(clusterProfiler)
library(rWikiPathways)
library(DOSE)
library(enrichplot)
```

## Load the data

The omics data comes in a uniform format with each row representing a patient/sample and each column representing a compound/feature/variable except the first column which contains the patient ID's.
The metadata has been cleaned for the variables of interest so that they are represented by new binary columns. See the preprocessing script for details.
```{r load_data}
setwd("~/R/FoL채k2")
metabolites <- read_csv("results/metabolite_preprocessed.csv")
proteins <- read_csv("results/protein_preprocessed.csv")
miRNA <- read_csv("results/miRNA_preprocessed.csv")

metadata <- read_csv("results/metadata_preprocessed.csv")

metadata_metabolites <- read_csv("data/metadata_metabolomics.csv")
metadata_proteins <- readxl::read_excel("data/Olink_proteins_metadata.xlsx")
```

These are the results from the WGCNA analysis containing all compounds (miRNA, protein, metabolites) their module membership and gene significance.
```{r load_results}
setwd("~/R/FoL채k2")
multi_omics_bilirubin <- read_csv("results/WGCNA/multi_omics_bilirubin.csv")
multi_omics_bilirubin_binary <- read_csv("results/WGCNA/multi_omics_bilirubin_binary.csv")
```

## Prepare the data

The patient ID column is set as the rownames to keep track of the rows.
The metabolite data was probably not log2 transformed but only scaled with 1 as the median and all other values proportional.
-> The metabolite data needs to be log2 transformed
The numerical columns of interest are selected in the metadata
```{r format_data}
miRNA <- miRNA %>% 
  column_to_rownames(var = "patient_id") %>% 
  slice(1:33)
miRNA <- miRNA[,-nearZeroVar(miRNA, uniqueCut = 30)] # cuts 978 miRNA (only mature); cuts 1920 miRNA (mature and hairpin) 

proteins <- proteins %>% 
  column_to_rownames(var = "patient_id") %>% 
  slice(1:33)

metabolites <- metabolites %>% 
  column_to_rownames(var = "patient_id") %>% 
  log2() %>% 
  slice(1:33)
metabolites <- metabolites[,-nearZeroVar(metabolites, uniqueCut = 30)] # cuts 29 metabolites

metadata <- metadata %>% 
  column_to_rownames(var = "patient_id") %>% 
  select(cca_binary, ibd_binary, fibrosis, fibrosis_binary, alp, alp_binary, bilirubin, bilirubin_binary) %>% 
  slice(1:33)
```

```{r save_compound_names}
# miRNA
miRNA_names <- names(miRNA)

setwd("~/R/FoL채k2")
mature <- read_csv('data/miRNA_mature_log.csv') %>% select(1)
hairpin <- read_csv('data/miRNA_hairpin_log.csv') %>% select(1)

write_csv(mature, "data/mature.csv")
write_csv(hairpin, "data/hairpin.csv")

# Proteins
proteins_names <- names(proteins)

# Metabolites
metabolites_names <- names(metabolites)
```

# Metabolite enrichment
Additional: Reactome

Analysis of metabolites for bilirubin with metadata containg the metabolic pathways.
```{r metabolites_bilirubin}
# for turquoise module
bilirubin_metabolites <- multi_omics_bilirubin %>% 
  filter(compounds %in% metabolites_names, 
         moduleColor == "turquoise", 
         abs(GS.bilirubin) > 0.5, 
         abs(MM.turquoise) > 0.5)

metadata_metabolites %>% 
  filter(`COMP ID` %in% bilirubin_metabolites$compounds) %>% 
  group_by(`SUB PATHWAY`) %>%
  summarise(metabolites = n()) %>%
  arrange(desc(metabolites)) %>% 
  datatable()
```

Analysis of metabolites for bilirubin with metadata containg the metabolic pathways.
```{r metabolites_bilirubin_binary}
# for turquoise module
bilirubin_binary_metabolites <- multi_omics_bilirubin_binary %>% 
  filter(compounds %in% metabolites_names, 
         moduleColor == "turquoise", 
         abs(GS.bilirubin_binary) > 0.5, 
         abs(MM.turquoise) > 0.5)

metadata_metabolites %>% 
  filter(`COMP ID` %in% bilirubin_binary_metabolites$compounds) %>% 
  group_by(`SUB PATHWAY`) %>%
  summarise(metabolites = n()) %>%
  arrange(desc(metabolites)) %>% 
  datatable()
```

# miRNA enrichment
https://ccb-compute2.cs.uni-saarland.de/mieaa/

Analysis of miRNA for bilirubin with external tool miEAA that uses several other databases. 
```{r miRNA_bilirubin}
# for turquoise module
bilirubin_miRNA <- multi_omics_bilirubin %>% 
  filter(compounds %in% mature$...1, 
         moduleColor == "turquoise", 
         abs(GS.bilirubin) > 0.25)

write_csv(bilirubin_miRNA %>% select(1), "~/Downloads/miRNA.csv")
```

# Protein enrichment
Additional: GO, disease association db

Analysis of proteins for bilirubin. We conver the list of interesting proteins from OlinkID to Uniprot_ID with the protein metadata.
```{r proteins_bilirubin}
# for turquoise module
bilirubin_proteins <- multi_omics_bilirubin %>% 
  filter(compounds %in% proteins_names, 
         moduleColor == "turquoise", 
         abs(GS.bilirubin) > 0.5, 
         abs(MM.turquoise) > 0.5)

sig.ptn <- metadata_proteins %>% 
  filter(OlinkID %in% bilirubin_proteins$compounds)
```

### KEGG

We analyse the proteins with Uniprot_ID through the KEGG databse.
```{r KEGG}
## ----kegg_enrichment, message=FALSE, warning=FALSE-----------------------------------------------------------------------------------------------------
###Pathway enrichment using KEGG database
ans.kegg <- enrichKEGG(gene = sig.ptn$Uniprot_ID,
                       organism = 'hsa',
                       keyType = "uniprot",
                       pvalueCutoff = 1)
datatable(as.data.frame(ans.kegg))


## ----kegg_plots, message=FALSE, warning=FALSE----------------------------------------------------------------------------------------------------------
###Plotting
barplot(ans.kegg, showCategory=15)
dotplot(ans.kegg, showCategory=15) + ggtitle("KEGG")
upsetplot(ans.kegg)
ans.kegg1 <- pairwise_termsim(ans.kegg)
emapplot(ans.kegg1)
ego <- ans.kegg %>% 
       mutate(richFactor = Count / as.numeric(sub("/\\d+", "", BgRatio)))

ggplot(ego, showCategory = 15, 
       aes(richFactor, fct_reorder(Description, Count))) +
       geom_segment(aes(xend=0, yend = Description)) +
       geom_point(aes(color=p.adjust, size = Count)) +
       scale_color_gradientn (colours=c("#f7ca64", "#46bac2", "#7e62a3"), trans = "log10",
                              guide=guide_colorbar(reverse=TRUE, order=1)) +
       scale_size_continuous(range=c(2, 10)) +
       theme_dose(12) +
       xlab("Rich Factor") +
       ylab(NULL) +
       ggtitle("KEGG based pathway analysis")

ggplot(ego, showCategory = 15,   
       aes(Count, fct_reorder(Description, Count), fill=p.adjust)) +
       geom_col() +
       scale_fill_gradientn(colours=c("#f7ca64", "#b3eebe", "#7e62a3", "#371ea3"),
                            guide=guide_colorbar(reverse=TRUE)) +
       theme_dose(12) +
       xlab("Protein count") +
       ylab(NULL) +
       ggtitle("Pathway analysis based on KEGG")
```

### Wikipathways

We have to convert the Uniprot ID's to Entrez Gene ID's to analyse with wikipathways.
```{r wikipathways}
# setwd("~/R/FoL채k2")
# wikipathways <- readPathwayGMT("data/wikipathways-20240710-gmt-Homo_sapiens.gmt")
# ## ----sig_genes, message=FALSE, warning=FALSE-----------------------------------------------------------------------------------------------------------
# ###preparing protein list for wikipathway (get gene IDs)
# sig.ptn.list <- sig_ptn %>%
#               dplyr::select(EntrezGeneID)
# sig.ptn <- sig.ptn.list[[1]]
# ptn.Universe <- metadata_prot %>%
#                select(EntrezGeneID)
# ptn.Universe <- ptn.Universe[[1]]
# ptn.Universe <- unlist(mget(ptn.Universe, envir=org.Hs.egSYMBOL2EG, ifnotfound = NA))
# 
# 
# ## ----wikipathways, message=FALSE, warning=FALSE--------------------------------------------------------------------------------------------------------
# ###Importing Wikipathways data
# disease2gene <- wikipathways[, c("wpid", "gene")]
# disease2name <- wikipathways[, c("wpid", "name")]
# ###Computing enrichment 
# ans.wkp <- enricher(sig.ptn, TERM2GENE=disease2gene, TERM2NAME=disease2name, pvalueCutoff = 1, universe = ptn.Universe)
# datatable(as.data.frame(ans.wkp))
# 
# 
# ## ----wkp_plots-----------------------------------------------------------------------------------------------------------------------------------------
# ###plotting results
# barplot(ans.wkp, showCategory=15)
# dotplot(ans.wkp, showCategory=15) + ggtitle("Disease db")
# upsetplot(ans.wkp)
# ans.wkp1 <- pairwise_termsim(ans.wkp)
# emapplot(ans.wkp1)
# 
# 
# ## ----signaling, message=FALSE, warning=FALSE-----------------------------------------------------------------------------------------------------------
# ###More plotting
# ego <- ans.wkp %>% 
#        # filter(str_detect(Description, "Calcium")) %>%
#        # filter(p.adjust < 0.001, Count > 10) %>%
#        mutate(richFactor = Count / as.numeric(sub("/\\d+", "", BgRatio)))
# 
# ggplot(ego, showCategory = 15, 
#        aes(richFactor, fct_reorder(Description, Count))) +
#        geom_segment(aes(xend=0, yend = Description)) +
#        geom_point(aes(color=p.adjust, size = Count)) +
#        scale_color_gradientn (colours=c("#f7ca64", "#46bac2", "#7e62a3"), trans = "log10",
#                               guide=guide_colorbar(reverse=TRUE, order=1)) +
#        scale_size_continuous(range=c(2, 10)) +
#        theme_dose(12) +
#        xlab("Rich Factor") +
#        ylab(NULL) +
#        ggtitle("Wikipathways based enrichment analysis")
# 
# ggplot(ego, showCategory = 15, 
#        aes(Count, fct_reorder(Description, Count), fill=qvalue)) +
#        geom_col() +
#        scale_fill_gradientn(colours=c("#b3eebe", "#46bac2", "#371ea3"),
#                             guide=guide_colorbar(reverse=TRUE)) +
#        theme_dose(12) +
#        xlab("Normalized Enrichment Score") +
#        ylab(NULL) +
#        ggtitle("Wikipathway based analysis")

```

